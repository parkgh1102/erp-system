# 알림톡 전송 문제 해결 가이드

## 1단계: 브라우저에서 오류 확인

### 개발자 도구로 확인하기
1. 웹사이트에서 **F12** 키를 눌러 개발자 도구 열기
2. **Console** 탭 확인
   - "알림톡 자동 전송 오류" 메시지가 있는지 확인
   - 빨간색 오류 메시지 복사
3. **Network** 탭 확인
   - 전자서명 버튼 누르기 전에 Network 탭 열기
   - "전송 후 저장" 버튼 클릭
   - `upload-statement` 요청 찾기 → 상태 코드 확인 (200이면 성공)
   - `send-alimtalk` 요청 찾기 → 상태 코드 확인
   - 빨간색 표시된 요청이 있다면 클릭 → Response 탭에서 오류 메시지 확인

### 주요 확인 사항
- **upload-statement 실패**: Cloudinary 업로드 오류
- **send-alimtalk 실패**: 알림톡 API 오류

---

## 2단계: Azure 백엔드 로그 확인

### Azure Portal에서 로그 확인
```bash
# Azure CLI로 로그 확인
az webapp log tail --name erp1204backend --resource-group erp1204_group
```

또는 **Azure Portal**에서:
1. Azure Portal 로그인
2. App Services → erp1204backend
3. 왼쪽 메뉴 → **Monitoring** → **Log stream**
4. 전자서명 후 알림톡 전송 시도
5. 로그에서 오류 메시지 확인

### 확인해야 할 로그
```
알림톡 자동 전송 오류:
전자서명 완료 안내 알림톡 전송 시도:
전자서명 완료 안내 알림톡 응답:
```

---

## 3단계: 일반적인 해결 방법

### 문제 1: Cloudinary 환경변수 누락
**증상**: `upload-statement` API가 500 오류 반환

**해결**:
```bash
# Azure Web App에 환경변수 설정 확인
az webapp config appsettings list --name erp1204backend --resource-group erp1204_group | grep CLOUDINARY
```

필요한 환경변수:
- `CLOUDINARY_CLOUD_NAME`
- `CLOUDINARY_API_KEY`
- `CLOUDINARY_API_SECRET`

누락되었다면 추가:
```bash
az webapp config appsettings set --name erp1204backend --resource-group erp1204_group --settings \
  CLOUDINARY_CLOUD_NAME="your_cloud_name" \
  CLOUDINARY_API_KEY="your_api_key" \
  CLOUDINARY_API_SECRET="your_api_secret"
```

---

### 문제 2: 알림톡 템플릿 미승인
**증상**: `send-alimtalk` API에서 오류 반환, 응답 코드가 100이 아님

**확인**:
- 알림톡 템플릿 코드: `SJT_125177`
- 템플릿이 승인되었는지 확인 필요

**해결**:
알림톡 관리자 페이지에서 템플릿 상태 확인

---

### 문제 3: Azure 아웃바운드 네트워크 차단
**증상**: 알림톡 API 호출이 타임아웃

**확인**:
```bash
# Azure Web App에서 외부 API 테스트
az webapp ssh --name erp1204backend --resource-group erp1204_group

# SSH 접속 후
curl -v http://221.139.14.189/API/alimtalk_api
```

**해결**:
Azure App Service는 기본적으로 아웃바운드 연결을 허용하므로 문제 없어야 하지만,
방화벽 설정이 있다면 알림톡 API 주소를 허용 목록에 추가

---

### 문제 4: 거래처 전화번호 누락
**증상**: "거래처 전화번호가 등록되어 있지 않습니다" 오류

**확인**:
1. 해당 거래처 정보 확인
2. 전화번호 필드가 비어있는지 확인

**해결**:
거래처 관리 페이지에서 전화번호 입력

---

## 4단계: 임시 해결책

알림톡 자동 전송이 실패하더라도:
1. 전자서명은 정상적으로 저장됨
2. 전자서명 완료 후 **"알림톡 재전송"** 버튼 사용 가능
3. 수동으로 알림톡 재전송 시도

---

## 5단계: 코드 수정 (필요시)

### 알림톡 오류 시 더 자세한 로그 추가

backend/src/services/AlimtalkService.ts의 `sendESignatureStatement` 메서드에서
더 자세한 로그를 출력하도록 이미 설정되어 있습니다.

### 프론트엔드에서 오류 확인

브라우저 콘솔(F12 → Console)에서 다음 메시지 확인:
```
알림톡 자동 전송 오류: [상세 오류 메시지]
```

---

## 문제 해결 우선순위

1. ✅ **브라우저 Network 탭** 확인 (가장 빠름)
2. ✅ **Azure 로그** 확인
3. ✅ **Cloudinary 환경변수** 확인
4. ✅ **알림톡 템플릿** 승인 상태 확인
5. ✅ **거래처 전화번호** 확인

---

## 즉시 확인할 사항

다음 정보를 확인해주세요:
1. 브라우저 F12 → Network 탭에서 `upload-statement`와 `send-alimtalk` 요청의 상태 코드
2. Azure Portal 로그에서 알림톡 관련 오류 메시지
3. 거래처에 전화번호가 등록되어 있는지

위 정보를 알려주시면 정확한 해결 방법을 안내드리겠습니다.
